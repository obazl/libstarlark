load("@rules_cc//cc:defs.bzl", "cc_binary")

exports_files(["libsunlark.c"])

# DEFINES = ["DEBUG", "DEBUG_TRACE"]
DEFINES = []

cc_library(
    name  = "sunlark",
    visibility = ["//visibility:public"],
    # linkshared = 1,
    linkstatic = 1,
    srcs  = [
        "libsunlark.c",
        "libsunlark.h",
    ],
    defines = DEFINES,
    copts = select({
        # strdup is non-standard, not supported on linux in strict c11 mode
        "//bzl/host:macos": ["-std=c11"],
        "//bzl/host:linux": ["-std=gnu11"],
        "//conditions:default": ["-std=c11"],
    }) + [
        "-pedantic-errors",

        "-I$(GENDIR)/bindings/scheme",
        "-I$(GENDIR)/external/moonlark/binding/scheme",

        "-I", "$(GENDIR)/src/lib/starlark",
        "-I", "$(GENDIR)external/moonlark/src/lib/starlark",

        "-I", "vendored/logc",
        "-I", "external/moonlark/vendored/logc",

        "-I", "vendored/s7",
        "-I", "external/moonlark/vendored/s7",

        "-I", "vendored/uthash",
        "-I", "external/moonlark/vendored/uthash",
    ],
    deps = [
        ":ast_node_s7",
        ":ast_nodelist_s7",
        "//src/config",
        "//src/lib/starlark",
        "//vendored/logc",
        "//vendored/uthash",
        "//vendored/s7"
    ],
)

###########
cc_library(
    name  = "ast_node_s7",
    visibility = ["//visibility:public"],
    # linkshared = 1,
    linkstatic = 1,
    srcs  = [
        "ast_node_s7.c",
        "ast_node_s7.h",
    ],
    defines = DEFINES,
    copts = select({
        # strdup is non-standard, not supported on linux in strict c11 mode
        "//bzl/host:macos": ["-std=c11"],
        "//bzl/host:linux": ["-std=gnu11"],
        "//conditions:default": ["-std=c11"],
    }) + [
        "-pedantic-errors",

        "-I$(GENDIR)/bindings/scheme",
        "-I$(GENDIR)/external/moonlark/binding/scheme",

        "-I", "$(GENDIR)/src/lib/starlark",
        "-I", "$(GENDIR)external/moonlark/src/lib/starlark",

        "-I", "vendored/logc",
        "-I", "external/moonlark/vendored/logc",

        "-I", "vendored/s7",
        "-I", "external/moonlark/vendored/s7",

        "-I", "vendored/uthash",
        "-I", "external/moonlark/vendored/uthash",
    ],
    deps = [
        "//src/config",
        "//src/lib/starlark",
        "//vendored/logc",
        "//vendored/uthash",
        "//vendored/s7"
    ],
)

###########
cc_library(
    name  = "ast_nodelist_s7",
    visibility = ["//visibility:public"],
    # linkshared = 1,
    linkstatic = 1,
    srcs  = [
        "ast_nodelist_s7.c",
        "ast_nodelist_s7.h",
    ],
    defines = DEFINES,
    copts = select({
        # strdup is non-standard, not supported on linux in strict c11 mode
        "//bzl/host:macos": ["-std=c11"],
        "//bzl/host:linux": ["-std=gnu11"],
        "//conditions:default": ["-std=c11"],
    }) + [
        "-pedantic-errors",

        "-I$(GENDIR)/bindings/scheme",
        "-I$(GENDIR)/external/moonlark/binding/scheme",

        "-I", "$(GENDIR)/src/lib/starlark",
        "-I", "$(GENDIR)external/moonlark/src/lib/starlark",

        "-I", "vendored/logc",
        "-I", "external/moonlark/vendored/logc",

        "-I", "vendored/s7",
        "-I", "external/moonlark/vendored/s7",

        "-I", "vendored/uthash",
        "-I", "external/moonlark/vendored/uthash",
    ],
    deps = [
        "//src/config",
        "//src/lib/starlark",
        "//vendored/logc",
        "//vendored/uthash",
        "//vendored/s7"
    ],
)

########
genrule(
    name = "mkhdrs",
    srcs = [
        "libsunlark.c",
        "ast_node_s7.c",
        "ast_nodelist_s7.c",
        "//src/config:bazel_config.c",
        "//src/lib/starlark:mkhdrs-export",
    ],
    outs = [
        "libsunlark.h",
        "ast_node_s7.h",
        "ast_nodelist_s7.h",
    ],
    cmd = "\n".join([
        "SRC1=$(location libsunlark.c)",
        "SRCDIR1=`dirname $$SRC1`",
        "$(location //vendored/makeheaders) \\",
        "    $(location //src/config:bazel_config.c) \\",
        "    $(location //src/lib/starlark:mkhdrs-export) \\",
        "    $(location libsunlark.c) \\",
        "    $(location ast_node_s7.c) \\",
        "    $(location ast_nodelist_s7.c)",
        "cp $${SRCDIR1}/*.h $(@D)",
    ]),
    tools = ["//vendored/makeheaders"],
    visibility = ["//visibility:public"]
)
