exports_files(["moonlark_setup.c"])

cc_binary(
    name = "repl",
    srcs = [
        "//vendored/lua-5.4.3/src:lua.c",
        "//vendored/lua-5.4.3/src:lua.h",
        "//vendored/lua-5.4.3/src:srcs",
        "//bindings/lua:moonlark.c",
        "//bindings/lua:moonlark.h",
        # moonlark C impl code:
        # "//src/lib/moonlark:libmoonlark.h",
        # "//src/lib/moonlark:moonlark_api.h",
        # "//src/lib/moonlark:moonlark_config.c",
        # "//src/lib/moonlark:moonlark_config.h",
    ],
    copts = [
        "-I$(GENDIR)/bindings/lua", # moonlark.h
        # "-I$(GENDIR)/moonlark",
        "-I$(GENDIR)/src/lib/moonlark", # libmoonlark.h
        "-Iexternal/uthash/include",
        "-Ivendored/logc",
        "-Ivendored/lua-5.4.3/src",
    ],
    defines = [
        "LUA_USE_MACOSX",
    ],
    linkopts = [
        "-lm",
        "-ldl",
    ],
    deps = [
        "//src/lib/moonlark",   # C libmoonlark
        "//vendored/logc",
        "//vendored/lua-5.4.3/src:lualark" # lua runtime
    ],
    visibility = ["//visibility:public"],
)

cc_binary(
    name  = "edit",
    linkstatic = 1,
    srcs  = [
        "edit.c",
        "edit.h",
        "moonlark_setup.c",
        "moonlark_setup.h",
        "//src/lib/starlark:debug.c",
        "//src/lib/starlark:debug.h",
        "@uthash//:include",
    ],
    defines = ["DEBUG", "DEBUG_TRACE"],
    copts = [
        "-std=c11",
        "-pedantic-errors",

        "-I", "src",
        "-I", "$(GENDIR)/moonlark",
        "-I", "$(GENDIR)/src/lib/starlark", # starlark.h etc.
        "-I", "$(GENDIR)/src/lib/moonlark", # libmoonlark.h

        "-I", "vendored/logc",
        "-I", "external/obazl/vendored/logc",
        "-I", "external/tools_obazl/vendored/logc",

        "-I", "vendored/lua-5.4.3/src",

        "-I", "external/uthash/include",
    ],
    deps = [
        # "//src/lib/starlark:starlark",
        "//src/lib/moonlark:moonlark",
        "//vendored/logc",
        # libmoonlark pulls in liblualark
        # "//vendored/lua-5.4.3/src:lua"
    ],
)

genrule(
    name = "mkhdrs",
    srcs = [
        # "//src/lib/starlark:debug.c",
        "edit.c",
        "moonlark_setup.c",
    ],
    outs = [
        "edit.h",
        "moonlark_setup.h",
    ],
    cmd = "\n".join([
        "SRC1=$(location edit.c)",
        "SRCDIR1=`dirname $$SRC1`",
        "$(location @makeheaders//:makeheaders) \\",
        # "    $(location //src/lib/starlark:debug.c) \\",
        "    $(location edit.c) \\",
        "    $(location moonlark_setup.c)",
        "cp $${SRCDIR1}/*.h $(@D)",
    ]),
    tools = ["@makeheaders//:makeheaders"],
    visibility = ["//visibility:public"]
)
