load("@rules_cc//cc:defs.bzl", "cc_library")

test_suite(
    name = "sunlark",
    tests = [
        ":binding_val_strings",
        ":binding_val_vectors",
        ":bindings",
        ":definitions",
        ":loads",
        ":targets",
        ":tetrads",
        ":vectors",
    ])

COPTS = select({
    "//bzl/host:macos": ["-std=c11"],
    "//bzl/host:linux": ["-std=gnu11"],
    "//conditions:default": ["-std=c11"],
}) + [
    "-pedantic-errors",

        "-I$(GENDIR)/test/unit/sunlark",
    "-I$(GENDIR)/external/sealark/test/unit/sunlark",

        "-I$(GENDIR)/bindings/scheme",
    "-I$(GENDIR)/external/sealark/bindings/scheme",

        "-I$(GENDIR)/sealark",
    "-I$(GENDIR)/external/sealark/sealark",

        "-Ivendored/logc",
    "-Iexternal/sealark/vendored/logc",
    "-Ivendored/s7",
    "-Iexternal/sealark/vendored/s7",
    "-Ivendored/unity",
    "-Iexternal/sealark/vendored/unity",
    "-Ivendored/uthash",
    "-Iexternal/sealark/vendored/uthash",
]

DEPS = [
    "//sealark",
    "//bindings/scheme:sunlark",
    "//vendored/logc",
    "//vendored/s7",
    "//vendored/unity",
    "//vendored/uthash",
]

cc_test(
    name = "bindings",
    srcs = ["bindings.c", "bindings.h"],
    data = [":BUILD.test1"],
    copts = COPTS,
    deps = DEPS,
    linkstatic = 1
)

cc_test(
    name = "definitions",
    srcs = ["definitions.c", "definitions.h"],
    data = [":BUILD.test1"],
    copts = COPTS,
    deps = DEPS,
    linkstatic = 1
)

cc_test(
    name = "loads",
    srcs = ["loads.c", "loads.h"],
    data = [":BUILD.test1"],
    copts = COPTS,
    deps = DEPS,
    linkstatic = 1
)

cc_test(
    name = "targets",
    srcs = ["targets.c", "targets.h"],
    data = [":BUILD.test1"],
    copts = COPTS,
    deps = DEPS,
    linkstatic = 1
)

cc_test(
    name = "binding_val_strings",
    srcs = ["binding_val_strings.c", "binding_val_strings.h"],
    data = [":BUILD.strings"],
    copts = COPTS,
    deps = DEPS,
    linkstatic = 1
)

cc_test(
    name = "binding_val_vectors",
    srcs = ["binding_val_vectors.c", "binding_val_vectors.h"],
    data = [":BUILD.vectors"],
    copts = COPTS,
    deps = DEPS,
    linkstatic = 1
)

cc_test(
    name = "tetrads",
    srcs = ["paths_tetradic.c", "paths_tetradic.h"],
    data = [":BUILD.test1"],
    copts = COPTS,
    deps = DEPS,
    linkstatic = 1
)

cc_test(
    name = "vectors",
    srcs = ["vectors.c", "vectors.h"],
    data = [":BUILD.vectors"],
    copts = COPTS,
    deps = DEPS,
    linkstatic = 1
)

################################################################
genrule(
    name = "mkhdrs",
    srcs = [
        "//sealark:debug.c",
        "bindings.c",
        "definitions.c",
        "loads.c",
        "paths_tetradic.c",
        "binding_val_strings.c",
        "binding_val_vectors.c",
        "targets.c",
        "vectors.c"
    ],
    outs = [
        "bindings.h",
        "definitions.h",
        "loads.h",
        "paths_tetradic.h",
        "binding_val_strings.h",
        "binding_val_vectors.h",
        "targets.h",
        "vectors.h"
    ],
    cmd = "\n".join([
        "SRC1=$(location paths_tetradic.c)",
        "SRCDIR1=`dirname $$SRC1`",
        "$(location //vendored/makeheaders) \\",
        "    $(location //sealark:debug.c) \\",
        "    $(location bindings.c) \\",
        "    $(location definitions.c) \\",
        "    $(location loads.c) \\",
        "    $(location paths_tetradic.c) \\",
        "    $(location binding_val_strings.c) \\",
        "    $(location binding_val_vectors.c) \\",
        "    $(location targets.c) \\",
        "    $(location vectors.c)",
        "cp $${SRCDIR1}/*.h $(@D)",
    ]),
    tools = ["//vendored/makeheaders"],
    visibility = ["//visibility:public"]
)
